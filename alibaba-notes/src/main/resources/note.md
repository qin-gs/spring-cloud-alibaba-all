# SpringCloud 原理



## 1. Nacos 架构

**架构**

- 用户
- 核心
- 内核
- 插件

<img src="img/nacos架构.png" alt="nacos架构" style="zoom:30%;" />



**配置模型**

- 配置
- 配置管理
- 配置服务
- 配置项
- 命名空间
- 配置组
- 配置 ID：`${prefix} - ${spring.profiles.active} - ${file-extension}`
- 配置快照



通过 GRPC 长连接监听配置变更，server 端对比 client 端配置的 md5 和 本地 md5 ，不相等推送配置变更

SDK 会保存快照，服务端出现问题时从本地获取





## 2. Nacos 内核设计



### 一致性

同时运行 CP 和 AP协议

- 服务注册：最终一致性 (保证高可用，不能罢工)
- 配置管理：强一致性 (不能丢失配置，必须保证一半的节点把配置保存成功)



一致性协议：ConsistencyProtocol

数据存储抽象：KvStorage



### Distro 协议

保证分布式环境下每个节点上的服务信息状态能及时通知其他节点

AP 保证某些 nacos 节点故障后系统依然可以正常工作

- 每个节点是平等的都可以处理写请求，同时把新数据同步到其他节点
- 每个节点只负责部分数据，定时发送自己负责数据的校验值到其他节点保存数据一致性
- 每个阶段独立处理读请求，及时从本地发出响应



工作原理：

- 数据初始化：轮询所有的 distro 节点，向其他集群发送请求拉取全量数据
- 数据校验：各机器定期发送心跳，心跳信息为本机器上所有数据的元信息；检测到数据不一致发起全量请求
- 写操作：
- 写操作：



### Nacos 信息通道









